<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Blood Glucose Simulation Tool</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* CSS Variables for theme colors */
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --bg-light: #f0f4f8;
      --bg-dark1: #1e2327;
      --bg-dark2: #2b3036;
      --container-light: rgba(255, 255, 255, 0.96);
      --container-dark: rgba(40, 44, 52, 0.95);
      --text-light: #333;
      --text-dark: #eee;
      --shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      --transition: 0.5s;
    }
    /* Basic Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-light), #d9e2ec);
      color: var(--text-light);
      padding: 20px;
      transition: background var(--transition), color var(--transition);
    }
    .dark-theme {
      background: linear-gradient(135deg, var(--bg-dark1), var(--bg-dark2));
      color: var(--text-dark);
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--container-light);
      border-radius: 12px;
      padding: 30px;
      box-shadow: var(--shadow);
      transition: background var(--transition), box-shadow var(--transition);
    }
    .dark-theme .container { background: var(--container-dark); }
    h1, h2, h3 { text-align: center; margin-bottom: 20px; line-height: 1.3; }
    
    /* Theme Toggle */
    .toggle-theme { text-align: right; margin-bottom: 20px; }
    button {
      background-color: var(--primary-color); border: none; color: #fff;
      padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 1em;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover { background-color: var(--primary-hover); transform: scale(1.05); }
    button:focus { outline: 2px solid var(--primary-color); }
    .dark-theme button { background-color: var(--primary-hover); }
    
    /* Image Row */
    .image-row {
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 20px;
      margin-bottom: 20px;
    }
    .image-row img {
      max-width: 220px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    /* Back to Home Button Styling */
    .back-home { text-align: center; margin-bottom: 20px; }
    
    /* Chart Containers */
    .chart-wrapper {
      width: 100%; max-width: 800px; margin: 0 auto 40px auto;
      position: relative; height: 400px; 
    }
    canvas { width: 100% !important; height: 100% !important; }
    
    /* Toggle Checkboxes */
    .series-toggles { text-align: center; margin-bottom: 20px; }
    .series-toggles span { display: inline-block; margin: 0 10px; }
    .series-toggles label { margin-left: 5px; font-weight: bold; }
    
    /* Diet Bubble Chart */
    .diet-section { margin-top: 40px; text-align: center; }
    .region-filter { text-align: center; margin-bottom: 20px; }
    .region-filter label { font-weight: bold; margin-right: 10px; }
    .region-filter select {
      padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em;
    }
    .dark-theme .region-filter select {
      background: #444; color: #fff; border: 1px solid #666;
    }
    
    /* Modal for Bubble Chart */
    #foodDetailModal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%; overflow: auto; 
      background-color: rgba(0,0,0,0.4); animation: fadeInModal 0.4s;
    }
    @keyframes fadeInModal {
      from { background-color: rgba(0,0,0,0); }
      to { background-color: rgba(0,0,0,0.4); }
    }
    .food-modal-content {
      background: #fff; margin: 10% auto; padding: 20px;
      border-radius: 8px; max-width: 500px; position: relative;
      animation: slideDown 0.4s;
    }
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .dark-theme .food-modal-content { background: #333; color: #fff; }
    .food-modal-close {
      position: absolute; top: 10px; right: 15px; color: #aaa;
      font-size: 22px; font-weight: bold; cursor: pointer;
    }
    .food-modal-close:hover { color: #000; }
    
    /* Simulation Tool */
    .glucose-tool { margin-top: 40px; text-align: center; }
    .glucose-tool h2 { margin-bottom: 15px; }
    .food-planner {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px;
    }
    .planner-section {
      display: flex; flex-direction: column; align-items: center;
    }
    .planner-section label { font-weight: bold; margin-bottom: 5px; }
    .planner-section select {
      padding: 8px; border-radius: 4px; border: 1px solid #ccc; min-width: 150px; max-height: 200px;
    }
    .dark-theme .planner-section select {
      background: #444; color: #fff; border: 1px solid #666;
    }
    .glucose-tool button { margin-top: 10px; }
    
    /* Additional Criteria */
    .additional-criteria { text-align: center; margin-bottom: 20px; }
    .additional-criteria label { font-weight: bold; margin: 0 10px; }
    .additional-criteria select {
      padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; margin: 0 5px;
    }
    
    /* Write-Up */
    .writeup {
      margin-top: 40px; padding: 20px; background-color: #f9f9f9;
      border-left: 5px solid var(--primary-color);
    }
    @keyframes fadeInChart {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .food-planner { flex-direction: column; }
      .chart-wrapper { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Theme Toggle -->
    <div class="toggle-theme">
      <button id="themeToggle" aria-label="Toggle Dark/Light Theme">Toggle Theme</button>
    </div>
    
    <!-- Back to Home Button -->
    <div class="back-home">
      <button onclick="window.location.href='index.html';" aria-label="Back to Home">Back to Home</button>
    </div>
    
    <!-- Image Row -->
    <div class="image-row">
      <img src="1.png" alt="AI concept for healthcare" />
      <img src="2.png" alt="Stethoscope and brain diagram on laptop" />
      <img src="3.png" alt="Glucose sensor scanning on phone" />
      <img src="4.png" alt="Hand-held glucose monitor" />
    </div>
    
    <h1>Enhanced Blood Glucose Simulation Tool</h1>
    <p style="text-align:center;">
      Choose your foods, meal times, lifestyle factors, and filter by food quality then click “Plot Day” to see your simulated blood glucose response.
    </p>
    
    <!-- Condition Chart (for demonstration) -->
    <div class="series-toggles">
      <span>
        <input type="checkbox" id="hashimotoToggle" checked>
        <label for="hashimotoToggle">Hashimoto’s</label>
      </span>
      <span>
        <input type="checkbox" id="b12Toggle" checked>
        <label for="b12Toggle">B12 Deficiency</label>
      </span>
      <span>
        <input type="checkbox" id="ironToggle" checked>
        <label for="ironToggle">Iron Deficiency</label>
      </span>
      <span>
        <input type="checkbox" id="hypotensionToggle" checked>
        <label for="hypotensionToggle">Hypotension</label>
      </span>
      <span>
        <input type="checkbox" id="hypoglycemiaToggle" checked>
        <label for="hypoglycemiaToggle">Hypoglycemia</label>
      </span>
    </div>
    
    <div class="chart-wrapper" style="animation: fadeInChart 1s ease;">
      <canvas id="myChart" aria-label="Condition chart" role="img"></canvas>
    </div>
    
    <!-- Diet Bubble Chart -->
    <div class="diet-section" style="animation: fadeInChart 1s ease;">
      <h2>Recommended Diets & Foods</h2>
      <p>Explore foods from different regions. Click on a bubble for details.</p>
      <div class="region-filter">
        <label for="regionSelect">Filter by Region:</label>
        <select id="regionSelect">
          <option value="All">All</option>
          <option value="South Indian">South Indian</option>
          <option value="North Indian">North Indian</option>
          <option value="Italian">Italian</option>
          <option value="Thai">Thai</option>
          <option value="Fusion">Fusion</option>
        </select>
      </div>
      <div class="chart-wrapper" style="animation: fadeInChart 1s ease;">
        <canvas id="dietChart" aria-label="Diet bubble chart" role="img"></canvas>
      </div>
    </div>
    
    <!-- Blood Glucose Simulation Tool -->
    <div class="glucose-tool" style="animation: fadeInChart 1s ease;">
      <h2>Blood Glucose Simulation</h2>
      <p style="max-width:700px; margin:0 auto; line-height:1.5;">
        Select your foods for each meal. Use the filters below to narrow your choices and select your meal times. Then choose lifestyle factors, meal size, and indicate if you’re diagnosed with hypoglycemia.
      </p>
      
      <!-- Food Category Filter and Meal Time Selectors -->
      <div class="additional-criteria">
        <label for="foodFilterSelect">Food Category Filter:</label>
        <select id="foodFilterSelect">
          <option value="All" selected>All</option>
          <option value="Good">Good</option>
          <option value="OK">OK</option>
          <option value="Bad">Bad</option>
        </select>
        <br/><br/>
        <label for="morningTimeSelect">Morning Time:</label>
        <select id="morningTimeSelect"></select>
        <label for="afternoonTimeSelect">Afternoon Time:</label>
        <select id="afternoonTimeSelect"></select>
        <label for="eveningTimeSelect">Evening Time:</label>
        <select id="eveningTimeSelect"></select>
      </div>
      
      <!-- Meal Size Selector -->
      <div class="additional-criteria">
        <label for="mealSizeSelect">Meal Size:</label>
        <select id="mealSizeSelect">
          <option value="small">Small</option>
          <option value="medium" selected>Medium</option>
          <option value="large">Large</option>
        </select>
      </div>
      
      <!-- Simulation Foods Multi-selects -->
      <div class="food-planner">
        <div class="planner-section">
          <label for="morningSelect">Morning Foods</label>
          <select id="morningSelect" multiple></select>
        </div>
        <div class="planner-section">
          <label for="afternoonSelect">Afternoon Foods</label>
          <select id="afternoonSelect" multiple></select>
        </div>
        <div class="planner-section">
          <label for="eveningSelect">Evening Foods</label>
          <select id="eveningSelect" multiple></select>
        </div>
      </div>
      
      <!-- Additional Lifestyle Criteria -->
      <div class="additional-criteria">
        <label for="sleepSelect">Sleep Quality/Duration:</label>
        <select id="sleepSelect">
          <option value="veryPoor">Very Poor (&lt;5 hrs)</option>
          <option value="poor">Poor (5–7 hrs)</option>
          <option value="normal" selected>Normal (7–9 hrs)</option>
          <option value="optimal">Optimal (&gt;9 hrs)</option>
        </select>
        <label for="stressSelect">Stress Level:</label>
        <select id="stressSelect">
          <option value="low">Low</option>
          <option value="moderate" selected>Moderate</option>
          <option value="high">High</option>
        </select>
        <label for="activitySelect">Activity Level:</label>
        <select id="activitySelect">
          <option value="sedentary">Sedentary</option>
          <option value="moderate" selected>Moderate</option>
          <option value="active">Active</option>
        </select>
        <label for="hypoDiagSelect">Diagnosed with Hypoglycemia?</label>
        <select id="hypoDiagSelect">
          <option value="no" selected>No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
      
      <button id="plotDayBtn">Plot Day</button>
      <button id="clearGlucoseBtn">Clear</button>
      <button id="downloadChartBtn" aria-label="Download Glucose Chart">Download Chart</button>
      
      <div class="chart-wrapper" style="animation: fadeInChart 1s ease;">
        <canvas id="glucoseChart" aria-label="Blood Glucose Simulation Chart" role="img"></canvas>
      </div>
    </div>
    
    <!-- Reversal / Management Advice -->
    <div class="reversal-section" id="reversalSection" style="animation: fadeInChart 1s ease;">
      <h2>Reversal or Management Advice</h2>
      <p id="reversalContent"></p>
    </div>
    
    <!-- Write-Up on Blood Glucose Factors -->
    <div class="writeup">
      <h3>Understanding Blood Glucose Variations</h3>
      <p>
        <strong>Factors Affecting Blood Glucose:</strong> Blood sugar levels are influenced by the type and quality of carbohydrates consumed, sleep, stress, and physical activity.
      </p>
      <p>
        <strong>Spikes:</strong> Rapid increases force large insulin releases which over time may lead to insulin resistance.
      </p>
      <p>
        <strong>Drops:</strong> Excessively low levels can cause symptoms like shakiness and confusion.
      </p>
      <p>
        <strong>Oscillations:</strong> Wide fluctuations strain the body's regulatory systems and impair long-term metabolic control.
      </p>
      <p>
        <strong>Guidance:</strong> Maintaining a steady range (approximately 70–140 mg/dL) is ideal. If you experience frequent spikes, lows, or wide oscillations, review your diet and lifestyle and consult a healthcare professional.
      </p>
    </div>
    
    <div class="info-section" style="animation: fadeInChart 1s ease;">
      <h3>References & Additional Information</h3>
      <ul>
        <li><a href="https://www.mayoclinic.org/">Mayo Clinic</a></li>
        <li><a href="https://www.niddk.nih.gov/">NIDDK</a></li>
        <li><a href="https://www.endocrine.org/">The Endocrine Society</a></li>
      </ul>
      <p>
        <strong>Disclaimer:</strong> This simulation is approximate and for demonstration purposes only.
      </p>
    </div>
  </div>
  
  <!-- Modal for Bubble Chart Food Details -->
  <div id="foodDetailModal" role="dialog" aria-modal="true" aria-labelledby="modalFoodTitle">
    <div class="food-modal-content">
      <span class="food-modal-close" id="foodModalClose" aria-label="Close Modal">&times;</span>
      <h3 id="modalFoodTitle"></h3>
      <p id="modalFoodCategory"></p>
      <p id="modalFoodReplacement"></p>
    </div>
  </div>
  
  <script>
    /********************************************************
     * THEME TOGGLE WITH PERSISTENCE
     ********************************************************/
    const themeToggle = document.getElementById('themeToggle');
    // Load theme from localStorage
    if(localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-theme');
    }
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-theme');
      // Save preference
      localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    });
    
    /********************************************************
     * 1) CONDITION LINE CHART (Demo)
     ********************************************************/
    const ctx = document.getElementById('myChart').getContext('2d');
    let dataHashimoto = [40, 45, 60, 70];
    let dataB12 = [20, 25, 35, 50];
    let dataIron = [30, 40, 45, 55];
    let dataHypotension = [15, 20, 30, 35];
    let dataHypoglycemia = [25, 30, 40, 60];
    let labels = ["Mild", "Moderate", "Mod. Severe", "Severe"];
    const myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: "Hashimoto’s", data: dataHashimoto, borderColor: "rgba(255, 99, 132, 1)", backgroundColor: "rgba(255, 99, 132, 0.2)", fill: true },
          { label: "B12 Deficiency", data: dataB12, borderColor: "rgba(54, 162, 235, 1)", backgroundColor: "rgba(54, 162, 235, 0.2)", fill: true },
          { label: "Iron Deficiency", data: dataIron, borderColor: "rgba(255, 206, 86, 1)", backgroundColor: "rgba(255, 206, 86, 0.2)", fill: true },
          { label: "Hypotension", data: dataHypotension, borderColor: "rgba(75, 192, 192, 1)", backgroundColor: "rgba(75, 192, 192, 0.2)", fill: true },
          { label: "Hypoglycemia", data: dataHypoglycemia, borderColor: "rgba(153, 102, 255, 1)", backgroundColor: "rgba(153, 102, 255, 0.2)", fill: true }
        ]
      },
      options: {
        responsive: true, 
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Severity / Index' }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: context => `${context.dataset.label}: ${context.parsed.y}`
            }
          }
        }
      }
    });
    
    // Toggle dataset visibility for conditions
    document.getElementById('hashimotoToggle').addEventListener('change', function() {
      myChart.data.datasets[0].hidden = !this.checked;
      myChart.update();
    });
    document.getElementById('b12Toggle').addEventListener('change', function() {
      myChart.data.datasets[1].hidden = !this.checked;
      myChart.update();
    });
    document.getElementById('ironToggle').addEventListener('change', function() {
      myChart.data.datasets[2].hidden = !this.checked;
      myChart.update();
    });
    document.getElementById('hypotensionToggle').addEventListener('change', function() {
      myChart.data.datasets[3].hidden = !this.checked;
      myChart.update();
    });
    document.getElementById('hypoglycemiaToggle').addEventListener('change', function() {
      myChart.data.datasets[4].hidden = !this.checked;
      myChart.update();
    });
    
    /********************************************************
     * 2) BUBBLE CHART FOR DIET
     ********************************************************/
    // Sample data arrays for bubble chart
    const goodFoodsAll = [
      { x: 1, y: 1, r: 10, label: "Plain Idly", replacement: "Healthy; add chutney", region: "South Indian" },
      { x: 2, y: 1, r: 10, label: "Rava Idly", replacement: "Pair with coconut chutney", region: "South Indian" },
      { x: 3, y: 1, r: 10, label: "Pongal (light ghee)", replacement: "Add veggies, reduce ghee", region: "South Indian" },
      { x: 4, y: 1, r: 10, label: "Avocado Toast", replacement: "Use whole wheat bread", region: "Italian" }
    ];
    const okFoodsAll = [
      { x: 2, y: 2, r: 8, label: "Filter Coffee", replacement: "Reduce sugar", region: "South Indian" },
      { x: 3, y: 3, r: 8, label: "Pongal (regular)", replacement: "Reduce ghee", region: "South Indian" }
    ];
    const badFoodsAll = [
      { x: 3, y: 4, r: 10, label: "Fried Idly", replacement: "Try steaming", region: "South Indian" },
      { x: 4, y: 4, r: 10, label: "White Bread Toast", replacement: "Switch to whole wheat", region: "Fusion" }
    ];
    let goodFoods = JSON.parse(JSON.stringify(goodFoodsAll));
    let okFoods = JSON.parse(JSON.stringify(okFoodsAll));
    let badFoods = JSON.parse(JSON.stringify(badFoodsAll));
    let dietChart;
    function renderBubbleChart() {
      const bubbleDatasets = [
        {
          label: "Good Foods",
          data: goodFoods,
          backgroundColor: "rgba(46, 204, 113, 0.6)",
          borderColor: "rgba(39, 174, 96, 1)"
        },
        {
          label: "OK Foods",
          data: okFoods,
          backgroundColor: "rgba(241, 196, 15, 0.6)",
          borderColor: "rgba(243, 156, 18, 1)"
        },
        {
          label: "Bad Foods",
          data: badFoods,
          backgroundColor: "rgba(231, 76, 60, 0.6)",
          borderColor: "rgba(192, 57, 43, 1)"
        }
      ];
      if (dietChart) { dietChart.destroy(); }
      const dietCtx = document.getElementById('dietChart').getContext('2d');
      dietChart = new Chart(dietCtx, {
        type: 'bubble',
        data: { datasets: bubbleDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: context => context.raw.label
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Time of Day (1=Breakfast, 2=Mid-morning, 3=Lunch, 4=Afternoon, 5=Dinner, 6=Late night)"
              },
              min: 0,
              max: 7,
              ticks: { stepSize: 1 }
            },
            y: {
              title: { display: true, text: "Visual Spread" },
              min: 0,
              max: 5,
              ticks: { stepSize: 1 }
            }
          },
          animation: { duration: 1500, easing: 'easeOutBounce' },
          onClick: (evt, elements) => {
            if (elements.length > 0) {
              let element = elements[0];
              let datasetIndex = element.datasetIndex;
              let dataIndex = element.index;
              let clickedItem = dietChart.data.datasets[datasetIndex].data[dataIndex];
              openFoodModal(clickedItem, dietChart.data.datasets[datasetIndex].label);
            }
          }
        }
      });
    }
    const foodDetailModal = document.getElementById('foodDetailModal');
    const foodModalClose = document.getElementById('foodModalClose');
    const modalFoodTitle = document.getElementById('modalFoodTitle');
    const modalFoodCategory = document.getElementById('modalFoodCategory');
    const modalFoodReplacement = document.getElementById('modalFoodReplacement');
    function openFoodModal(item, category) {
      modalFoodTitle.textContent = item.label;
      modalFoodCategory.innerHTML = `<strong>Category:</strong> ${category} (Region: ${item.region})`;
      modalFoodReplacement.textContent = `Suggestion: ${item.replacement}`;
      foodDetailModal.style.display = 'block';
    }
    foodModalClose.addEventListener('click', () => {
      foodDetailModal.style.display = 'none';
    });
    window.addEventListener('click', (e) => {
      if (e.target == foodDetailModal) {
        foodDetailModal.style.display = 'none';
      }
    });
    const regionSelect = document.getElementById('regionSelect');
    regionSelect.addEventListener('change', applyRegionFilter);
    function applyRegionFilter() {
      const selected = regionSelect.value;
      goodFoods = goodFoodsAll.filter(item => (selected === "All") ? true : item.region === selected);
      okFoods = okFoodsAll.filter(item => (selected === "All") ? true : item.region === selected);
      badFoods = badFoodsAll.filter(item => (selected === "All") ? true : item.region === selected);
      renderBubbleChart();
    }
    renderBubbleChart();
    
    /********************************************************
     * 3) BLOOD GLUCOSE SIMULATION TOOL
     ********************************************************/
    // Global time axis: 6 AM to 10 PM (17 points)
    const globalTimeAxis = [];
    const globalTimeLabels = [];
    for(let hr = 6; hr <= 22; hr++){
      globalTimeAxis.push(hr);
      let label = hr < 12 ? hr + " AM" : (hr === 12 ? "12 PM" : (hr-12) + " PM");
      globalTimeLabels.push(label);
    }
    // Baseline: constant ~90 mg/dL
    let baselineData = new Array(globalTimeAxis.length).fill(90);
    
    // Food curves for each food
    const foodCurves = {
      "coffee": [90,100,95,90,85],
      "avocado": [85,88,87,85,83],
      "idly": [90,110,105,95,90],
      "dosa": [92,112,107,97,92],
      "medu vada": [95,115,110,100,95],
      "upma": [88,108,103,93,88],
      "pesarattu": [90,110,105,95,90],
      "rava idly": [92,112,107,97,92],
      "pongal": [95,120,110,100,95],
      "appam": [87,107,102,92,87],
      "poori": [100,130,125,115,110],
      "ragi dosa": [85,105,100,90,85],
      "neer dosa": [80,100,95,85,80],
      "adai": [90,110,105,95,90],
      "omelette": [80,90,85,80,75],
      "bagel": [95,125,120,110,105],
      "cereal": [85,120,115,105,100],
      "smoothie": [90,125,120,110,105],
      "granola": [88,118,113,103,98],
      "fruit salad": [75,90,85,80,75],
      "yogurt parfait": [80,95,90,85,80],
      "egg sandwich": [85,105,100,90,85],
      "french toast": [90,120,115,105,100],
      "waffles": [88,118,113,103,98],
      "pancakes": [90,120,115,105,100],
      "toast": [80,100,95,85,80],
      "muesli": [85,105,100,90,85],
      "scrambled eggs": [80,90,85,80,75],
      "protein shake": [75,95,90,85,80],
      "herbal tea": [70,80,75,70,65],
      "green tea": [70,80,75,70,65],
      "margherita pizza": [90,125,115,110,105],
      "pad thai": [88,118,113,103,98],
      "whole wheat pasta": [85,105,100,90,85],
      "burger": [88,120,115,105,100],
      "white bread": [85,130,120,110,100],
      "ice cream": [100,140,130,120,110],
      "hamburger": [90,120,110,105,100],
      "south indian veg meal (sambar, white rice)": [95,115,110,105,100],
      "south indian veg meal (sambar, yogurt, brown rice)": [90,110,105,100,95],
      "apple": [80,85,83,80,78],
      "banana": [85,95,90,85,80],
      "orange": [80,90,88,85,82],
      "mango": [90,105,100,95,90],
      "papaya": [90,105,100,95,90],
      "grapes": [80,95,90,85,80],
      "pear": [80,85,83,80,78],
      "kiwi": [85,95,90,85,80],
      "strawberry": [75,85,80,75,70],
      "blueberry": [80,90,85,80,75],
      "pineapple": [95,110,105,100,95],
      "chaat": [100,140,130,120,110],
      "bhel puri": [95,135,125,115,105],
      "pani puri": [90,130,120,110,100],
      "paav baaji": [100,140,135,125,115],
      "lemon juice": [70,75,72,70,68],
      "watermelon juice": [80,85,83,80,78],
      "sourdough bread": [80,105,100,95,90],
      "gluten free bread": [90,120,115,105,100],
      "protein milk shake (core)": [75,95,90,85,80]
    };
    // Simulate hypoglycemic response by subtracting 15 mg/dL
    function getHypoCurve(curve) {
      return curve.map(val => val - 15);
    }
    // Plugin to shade normal range (70–140 mg/dL)
    const normalRangePlugin = {
      id: 'normalRange',
      beforeDraw: (chart, args, options) => {
        const {ctx, chartArea: {top, bottom, left, right}, scales: {y}} = chart;
        const normalMin = options.normalMin || 70;
        const normalMax = options.normalMax || 140;
        const yNormalMin = y.getPixelForValue(normalMin);
        const yNormalMax = y.getPixelForValue(normalMax);
        ctx.save();
        ctx.fillStyle = options.backgroundColor || 'rgba(0,255,0,0.1)';
        ctx.fillRect(left, yNormalMax, right - left, yNormalMin - yNormalMax);
        ctx.restore();
      }
    };
    let baselineDataset = {
      label: "Baseline (Green)",
      data: baselineData,
      borderColor: "rgba(46, 204, 113, 1)",
      backgroundColor: "rgba(46, 204, 113, 0.2)",
      fill: true, tension: 0.2
    };
    
    // Glucose chart with custom tooltip for food info
    let glucoseChart = new Chart(document.getElementById('glucoseChart').getContext('2d'), {
      type: 'line',
      data: { labels: globalTimeLabels, datasets: [ baselineDataset ] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          normalRange: { normalMin: 70, normalMax: 140, backgroundColor: "rgba(0,255,0,0.1)" },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || "";
                if(context.dataset.tooltipInfo) {
                  label += " - " + context.dataset.tooltipInfo;
                }
                label += ": " + context.parsed.y;
                return label;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            suggestedMin: 60,
            suggestedMax: 150,
            title: { display: true, text: "Blood Glucose (mg/dL)" }
          }
        }
      },
      plugins: [normalRangePlugin]
    });
    
    // Additional tooltip info for foods
    const foodTooltips = {
      "coffee": "Caffeine may induce transient insulin resistance. (Mayo Clinic)",
      "avocado": "Low GI with healthy fats and fiber. (NIDDK)",
      "idly": "Low glycemic index; gradual blood sugar rise.",
      "dosa": "Fermented batter improves digestibility; moderate spike.",
      "medu vada": "Higher in starch; potential for sharper spikes.",
      "upma": "Moderate GI; gradual glucose increase.",
      "pesarattu": "Similar to idly; steady release.",
      "rava idly": "Slight spike; similar to idly.",
      "pongal": "Balanced with protein; watch portion size.",
      "appam": "Generally low GI with mild spike.",
      "poori": "High GI; significant spike and rapid dip."
      // ... (additional tooltip texts)
    };
    
    // Master simulationFoods array for meal selects
    const simulationFoods = [
      { value: "coffee", label: "Coffee", category: "OK" },
      { value: "avocado", label: "Avocado", category: "Good" },
      { value: "idly", label: "Idly", category: "Good" },
      { value: "dosa", label: "Dosa", category: "Good" },
      { value: "medu vada", label: "Medu Vada", category: "Good" },
      { value: "upma", label: "Upma", category: "Good" },
      { value: "pesarattu", label: "Pesarattu", category: "Good" },
      { value: "rava idly", label: "Rava Idly", category: "Good" },
      { value: "pongal", label: "Pongal", category: "Good" },
      { value: "appam", label: "Appam", category: "Good" },
      { value: "poori", label: "Poori", category: "Bad" },
      { value: "ragi dosa", label: "Ragi Dosa", category: "Good" },
      { value: "neer dosa", label: "Neer Dosa", category: "Good" },
      { value: "adai", label: "Adai", category: "Good" },
      { value: "omelette", label: "Omelette", category: "Good" },
      { value: "bagel", label: "Bagel", category: "OK" },
      { value: "cereal", label: "Cereal", category: "OK" },
      { value: "smoothie", label: "Smoothie", category: "OK" },
      { value: "granola", label: "Granola", category: "OK" },
      { value: "fruit salad", label: "Fruit Salad", category: "Good" },
      { value: "yogurt parfait", label: "Yogurt Parfait", category: "Good" },
      { value: "egg sandwich", label: "Egg Sandwich", category: "OK" },
      { value: "french toast", label: "French Toast", category: "Bad" },
      { value: "waffles", label: "Waffles", category: "Bad" },
      { value: "pancakes", label: "Pancakes", category: "Bad" },
      { value: "toast", label: "Toast", category: "OK" },
      { value: "muesli", label: "Muesli", category: "OK" },
      { value: "scrambled eggs", label: "Scrambled Eggs", category: "Good" },
      { value: "protein shake", label: "Protein Shake", category: "OK" },
      { value: "herbal tea", label: "Herbal Tea (Unsweetened)", category: "Good" },
      { value: "green tea", label: "Green Tea (Unsweetened)", category: "Good" },
      { value: "margherita pizza", label: "Margherita Pizza", category: "Bad" },
      { value: "pad thai", label: "Pad Thai", category: "OK" },
      { value: "whole wheat pasta", label: "Whole Wheat Pasta", category: "Good" },
      { value: "burger", label: "Burger", category: "Bad" },
      { value: "white bread", label: "White Bread", category: "Bad" },
      { value: "ice cream", label: "Ice Cream", category: "Bad" },
      { value: "hamburger", label: "Hamburger", category: "Bad" },
      { value: "south indian veg meal (sambar, white rice)", label: "South Indian Veg Meal (Sambar, White Rice)", category: "Good" },
      { value: "south indian veg meal (sambar, yogurt, brown rice)", label: "South Indian Veg Meal (Sambar, Yogurt, Brown Rice)", category: "Good" },
      { value: "apple", label: "Fresh Apple", category: "Good" },
      { value: "banana", label: "Fresh Banana", category: "Good" },
      { value: "orange", label: "Fresh Orange", category: "Good" },
      { value: "mango", label: "Fresh Mango", category: "Good" },
      { value: "papaya", label: "Fresh Papaya", category: "Good" },
      { value: "grapes", label: "Fresh Grapes", category: "Good" },
      { value: "pear", label: "Fresh Pear", category: "Good" },
      { value: "kiwi", label: "Fresh Kiwi", category: "Good" },
      { value: "strawberry", label: "Fresh Strawberry", category: "Good" },
      { value: "blueberry", label: "Fresh Blueberry", category: "Good" },
      { value: "pineapple", label: "Fresh Pineapple", category: "Good" },
      { value: "chaat", label: "Chaat", category: "Bad" },
      { value: "bhel puri", label: "Bhel Puri", category: "Bad" },
      { value: "pani puri", label: "Pani Puri", category: "Bad" },
      { value: "paav baaji", label: "Paav Baaji", category: "Bad" },
      { value: "lemon juice", label: "Lemon Juice (Unsweetened)", category: "OK" },
      { value: "watermelon juice", label: "Watermelon Juice", category: "OK" },
      { value: "sourdough bread", label: "Sourdough Bread", category: "OK" },
      { value: "gluten free bread", label: "Gluten Free Bread", category: "OK" },
      { value: "protein milk shake (core)", label: "Protein Milk Shake (Core)", category: "OK" }
    ];
    
    // Populate meal select menus based on food filter
    const morningSelect = document.getElementById('morningSelect');
    const afternoonSelect = document.getElementById('afternoonSelect');
    const eveningSelect = document.getElementById('eveningSelect');
    const foodFilterSelect = document.getElementById('foodFilterSelect');
    
    function populateFoodSelects() {
      const filter = foodFilterSelect.value;
      [morningSelect, afternoonSelect, eveningSelect].forEach(select => select.innerHTML = "");
      const filteredFoods = simulationFoods.filter(item => filter === "All" || item.category === filter);
      filteredFoods.forEach(food => {
        const option = document.createElement("option");
        option.value = food.value;
        option.textContent = food.label;
        [morningSelect, afternoonSelect, eveningSelect].forEach(select => select.appendChild(option.cloneNode(true)));
      });
    }
    foodFilterSelect.addEventListener('change', populateFoodSelects);
    populateFoodSelects();
    
    // Populate meal time select menus
    const morningTimeSelect = document.getElementById('morningTimeSelect');
    const afternoonTimeSelect = document.getElementById('afternoonTimeSelect');
    const eveningTimeSelect = document.getElementById('eveningTimeSelect');
    function populateTimeSelect(select, startHour, endHour) {
      select.innerHTML = "";
      for(let hr = startHour; hr <= endHour; hr++){
        let option = document.createElement("option");
        option.value = hr;
        option.textContent = hr < 12 ? hr + " AM" : (hr === 12 ? "12 PM" : (hr-12) + " PM");
        select.appendChild(option);
      }
    }
    populateTimeSelect(morningTimeSelect, 6, 10);
    populateTimeSelect(afternoonTimeSelect, 12, 15);
    populateTimeSelect(eveningTimeSelect, 18, 21);
    
    // Colors for food curves
    function getColor(idx) {
      const colors = [
        "rgba(54, 162, 235, 1)",
        "rgba(255, 159, 64, 1)",
        "rgba(153, 102, 255, 1)",
        "rgba(75, 192, 192, 1)",
        "rgba(255, 205, 86, 1)"
      ];
      return colors[idx % colors.length];
    }
    
    // Plot Day functionality
    const sleepSelect = document.getElementById('sleepSelect');
    const stressSelect = document.getElementById('stressSelect');
    const activitySelect = document.getElementById('activitySelect');
    const hypoDiagSelect = document.getElementById('hypoDiagSelect');
    const mealSizeSelect = document.getElementById('mealSizeSelect');
    const plotDayBtn = document.getElementById('plotDayBtn');
    const clearGlucoseBtn = document.getElementById('clearGlucoseBtn');
    const downloadChartBtn = document.getElementById('downloadChartBtn');
    
    plotDayBtn.addEventListener('click', () => {
      let adjustedBaseline = [...baselineData];
    
      // Adjust baseline by lifestyle factors
      const sleepAdj = { "veryPoor": 10, "poor": 5, "normal": 0, "optimal": -5 };
      const stressAdj = { "high": 10, "moderate": 5, "low": -5 };
      const activityAdj = { "sedentary": 5, "moderate": 0, "active": -10 };
    
      adjustedBaseline = adjustedBaseline.map(val => val + (sleepAdj[sleepSelect.value] || 0));
      adjustedBaseline = adjustedBaseline.map(val => val + (stressAdj[stressSelect.value] || 0));
      adjustedBaseline = adjustedBaseline.map(val => val + (activityAdj[activitySelect.value] || 0));
    
      baselineDataset.data = adjustedBaseline;
      glucoseChart.data.datasets = [ baselineDataset ];
      
      // Meal time indices based on global axis (6 AM start)
      const morningTime = parseInt(morningTimeSelect.value);
      const afternoonTime = parseInt(afternoonTimeSelect.value);
      const eveningTime = parseInt(eveningTimeSelect.value);
      const morningIndex = morningTime - 6;
      const afternoonIndex = afternoonTime - 6;
      const eveningIndex = eveningTime - 6;
      
      // Determine meal size factor
      const mealSize = mealSizeSelect.value;
      let factor = mealSize === "small" ? 0.8 : (mealSize === "large" ? 1.2 : 1.0);
      
      function addFoodDataset(foodValue, startIndex, idx) {
        if(foodCurves[foodValue]) {
          // Adjust food curve based on meal size factor
          const curve = foodCurves[foodValue].map(val => val * factor);
          let xVals = [], yVals = [];
          for(let i = 0; i < curve.length; i++){
            let pos = startIndex + i;
            if(pos < globalTimeAxis.length) {
              xVals.push(globalTimeLabels[pos]);
              yVals.push(curve[i]);
            }
          }
          let ds = {
            label: `Food: ${foodValue}`,
            data: xVals.map((x, i) => ({ x: x, y: yVals[i] })),
            borderColor: getColor(idx),
            backgroundColor: "rgba(0,0,0,0)",
            fill: false,
            tension: 0.2,
            borderWidth: 2,
            borderDash: [4,4],
            tooltipInfo: foodTooltips[foodValue] || "No additional data available"
          };
          glucoseChart.data.datasets.push(ds);
    
          // Add hypoglycemic variant if selected
          if(hypoDiagSelect.value === "yes") {
            let hypoCurve = getHypoCurve(curve);
            let hypoX = [], hypoY = [];
            for(let i = 0; i < hypoCurve.length; i++){
              let pos = startIndex + i;
              if(pos < globalTimeAxis.length) {
                hypoX.push(globalTimeLabels[pos]);
                hypoY.push(hypoCurve[i]);
              }
            }
            let hypoDS = {
              label: `Hypo: ${foodValue}`,
              data: hypoX.map((x, i) => ({ x: x, y: hypoY[i] })),
              borderColor: "rgba(255,0,0,1)",
              backgroundColor: "rgba(255,0,0,0.2)",
              fill: false,
              tension: 0.2,
              borderWidth: 2,
              borderDash: [4,4],
              tooltipInfo: foodTooltips[foodValue]
                ? ("Hypo variant - " + foodTooltips[foodValue])
                : "No additional data available"
            };
            glucoseChart.data.datasets.push(hypoDS);
          }
        }
      }
      
      const morningFoods = Array.from(morningSelect.selectedOptions).map(o => o.value);
      const afternoonFoods = Array.from(afternoonSelect.selectedOptions).map(o => o.value);
      const eveningFoods = Array.from(eveningSelect.selectedOptions).map(o => o.value);
      let idx = 0;
      morningFoods.forEach(food => { addFoodDataset(food, morningIndex, idx++); });
      afternoonFoods.forEach(food => { addFoodDataset(food, afternoonIndex, idx++); });
      eveningFoods.forEach(food => { addFoodDataset(food, eveningIndex, idx++); });
      
      glucoseChart.options.animation = { duration: 2000, easing: 'easeInOutQuad' };
      glucoseChart.update();
      setTimeout(() => {
        glucoseChart.options.animation = {};
      }, 2200);
    });
    
    clearGlucoseBtn.addEventListener('click', () => {
      baselineDataset.data = baselineData;
      glucoseChart.data.datasets = [ baselineDataset ];
      glucoseChart.update();
    });
    
    // Download chart as image
    downloadChartBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = document.getElementById('glucoseChart').toDataURL('image/png');
      link.download = 'glucose_simulation_chart.png';
      link.click();
    });
    
    /********************************************************
     * 4) REVERSAL / MANAGEMENT ADVICE
     ********************************************************/
    const reversalContent = document.getElementById('reversalContent');
    reversalContent.innerHTML = `
      <strong>Hashimoto’s Thyroiditis:</strong> Usually managed with hormone therapy and regular monitoring.<br/><br/>
      <strong>Vitamin B12 Deficiency:</strong> Often reversible with supplementation and diet changes.<br/><br/>
      <strong>Iron Deficiency:</strong> May be reversed by addressing underlying causes and improving dietary intake.<br/><br/>
      <strong>Low Blood Pressure:</strong> Can be managed with fluids, salt, and addressing root causes.<br/><br/>
      <strong>Hypoglycemia:</strong> Requires balanced meals and careful monitoring to avoid dangerous lows.<br/><br/>
      <em>Always consult a healthcare professional for personalized guidance.</em>
    `;
  </script>
</body>
</html>
